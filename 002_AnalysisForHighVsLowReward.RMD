---
output: html_document
editor_options: 
  chunk_output_type: console
---
## Callin Switzer
## 17 Nov 2017
## Multilevel model to visualize bees'
## behavior on the artificial pollen system



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Users/cswitzer/Dropbox/SonicationBehavior")
```


```{R}
#install packages
ipak <- function(pkg){
     new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
     if(length(new.pkg)) install.packages(new.pkg, dependencies = TRUE)
     sapply(pkg, require, character.only = TRUE)
}

packages <- c("gsheet", "ggplot2", "reshape2", "pwr", 'lme4', 'sjPlot', 'gsheet')
ipak(packages)

# set ggplot theme
theme_set(theme_bw())

# define data and figure directories
dataDir <- "/Users/cswitzer/Dropbox/SonicationBehavior/SonBehData"
figDir <- "/Users/cswitzer/Dropbox/SonicationBehavior/SonBehFigs"


sl <- read.csv(file.path(dataDir, 'freqLearn2_updated.csv'))

# get hive
sl$hive <- sapply(1:nrow(sl), FUN = function(ii) {
     s1 <- strsplit(as.character(sl$BeeNumCol[ii]), split = "[hH]ive")[[1]][2]
     strsplit(s1, "_")[[1]][1]
})

# remove test rows
sl <- sl[sl$beeCol != 'TESTTESTPHOTO',]

table(sl$hive, useNA = 'always')

## make sure all bee colors are lowercase
sl$beeCol <- tolower(sl$beeCol)



# make sure there are values lower than 220 and higher than 450 (the cutoff for buzzes used in the experiment)
hist(sl$freq)
sl[sl$freq < 220 | sl$freq > 450,] # should have 0 rows

# plot each bee's frequency over time by treatment
# ggplot(sl, aes(x = freq, y = amp)) +
#      geom_point()


## Add IT Span to dataset
URL = 'https://docs.google.com/spreadsheets/d/1qbld3hmg-11BYmHhO6VXJ89-60xG8hY5nqmf2yKuXKQ/edit?usp=sharing'
mtadta <- gsheet2tbl(URL)

md2 <- gsheet2tbl('https://docs.google.com/spreadsheets/d/12f5Yca-MYAtvCw1WmViqPoil6LUsUsJhWK9W9tAyvp4/edit?usp=sharing')

md2 <- data.frame(md2[!is.na(md2$IT), c('BeeColorNum', 'IT')])

# get bee sizes
md <- data.frame(mtadta[!is.na(mtadta$IT), c('BeeColorNum', 'IT') ])

md <- rbind(md, md2)
table(md$BeeColorNum)
sum(table(md$BeeColorNum) != 1) # check to make sure I don't have repeated bees


# merge md into full dataset
md
head(sl)

sl_2 <- merge(md, sl, by.x = c("BeeColorNum"), by.y = ("beeCol"), all = TRUE)
head(sl_2)

sl <- sl_2


table(interaction(sl$BeeColorNum, sl$IT))[table(interaction(sl$BeeColorNum, sl$IT)) != 0]

# see how many rows are missing IT Span
nrow(sl[is.na(sl$IT), ]) # this is just a few bees
unique(sl[is.na(sl$IT), 'BeeColorNum']) # three bees




sl<- sl[!is.na(sl$BeeColorNum), ]

ggplot(sl, aes(x = index, y = freq, color = BeeColorNum)) + 
     geom_point(aes(shape = as.factor(trialNum))) + 
     facet_wrap(~BeeColorNum) + 
     theme(legend.position = "none")



hist(sl$freq)
trt <- character()
     
for(ii in 1:nrow(sl)){
     low <- sl$lowFrq[ii]
     high <- sl$highFrq[ii]
     if(low == 220  & high == 450) trt[ii] = 'initial'
     else if(low == 500) trt[ii] = 'unrewarded'
     else if(low > 250) trt[ii] = 'high'
     else if(low < 250 & high <= 350) trt[ii] = 'low'
}


sl$trt <- trt

# plot initial freq vs. IT span
ITss = data.frame(IT = (tapply(sl$IT, INDEX = sl$BeeColorNum, function(x) x[1])))
meanFreq = data.frame(meanFreq = tapply(sl$freq[sl$trt == "initial"], INDEX = sl$BeeColorNum[sl$trt == "initial"], mean))

avgdf = merge(ITss, meanFreq, by = 'row.names')
avgdf = avgdf[complete.cases(avgdf), ]


plot(avgdf$meanFreq ~ avgdf$IT)
abline(lm(avgdf$meanFreq ~ avgdf$IT))
text(x = 4.5, y = 400, "Bigger bees buzz at lower frequencies")
sl[sl$IT < 3.1, ]

# look at treatments
head(sl)
xtabs(~sl$BeeColorNum + trt, data = sl )
```